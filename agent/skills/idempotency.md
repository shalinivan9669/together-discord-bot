# Idempotency Skill

## Цель

Гарантировать корректный конечный результат при retry, double-click и повторной доставке job.

## Do

- Сначала проектировать уникальные ограничения на уровне БД.
- Оборачивать multi-write flows в транзакции.
- Использовать deterministic dedupe keys для interaction-path.
- Использовать advisory locks в race-чувствительных стартах/закрытиях.
- Возвращать "already processed" как корректный результат, где это допустимо.

## Don't

- Не полагаться только на in-memory dedupe.
- Не считать retry ошибкой по умолчанию.
- Не начислять очки/создавать сущности без idempotency-гарантий.

## Типовой паттерн

1. Сформировать idempotency key.
2. Попробовать зафиксировать операцию (`op_dedup`/unique insert).
3. Если операция уже была - вернуть existing/accepted результат.
4. Иначе выполнить транзакцию и зафиксировать состояние.

## Проверка качества

- Повтор того же действия не создает вторую запись.
- Повтор job не вызывает рассинхрон.
- На гонке между двумя запросами выигрывает один, второй корректно отклоняется/сливается.
